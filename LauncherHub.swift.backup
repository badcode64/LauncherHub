import Cocoa
import WebKit

// MARK: - Data Model

struct QuickLink: Codable {
    var id: String
    var title: String
    var icon: String
    var color: String
    var actionType: String
    var payload: String
    
    init(title: String, icon: String = "üîó", color: String = "#3b82f6", actionType: String = "Finder", payload: String = "") {
        self.id = UUID().uuidString
        self.title = title
        self.icon = icon
        self.color = color
        self.actionType = actionType
        self.payload = payload
    }
}

struct LinkGroup: Codable {
    var id: String
    var title: String
    var x: Int
    var y: Int
    var links: [QuickLink]
    
    init(title: String, x: Int, y: Int, links: [QuickLink] = []) {
        self.id = UUID().uuidString
        self.title = title
        self.x = x
        self.y = y
        self.links = links
    }
}

// MARK: - Script Message Handler

class WebHandler: NSObject, WKScriptMessageHandler {
    weak var delegate: AppDelegate?
    
    func userContentController(_ userContentController: WKUserContentController, didReceive message: WKScriptMessage) {
        guard let body = message.body as? [String: Any],
              let action = body["action"] as? String else { return }
        
        DispatchQueue.main.async {
            switch action {
            case "click":
                if let linkId = body["linkId"] as? String {
                    self.delegate?.executeLink(linkId: linkId)
                }
            case "addLink":
                if let groupId = body["groupId"] as? String {
                    self.delegate?.showAddDialog(groupId: groupId)
                }
            case "editLink":
                if let linkId = body["linkId"] as? String, let groupId = body["groupId"] as? String {
                    self.delegate?.showEditDialog(groupId: groupId, linkId: linkId)
                }
            case "moveGroup":
                if let groupId = body["groupId"] as? String,
                   let x = body["x"] as? Int,
                   let y = body["y"] as? Int {
                    self.delegate?.moveGroup(groupId: groupId, x: x, y: y)
                }
            case "addGroup":
                self.delegate?.showAddGroupDialog()
            case "editGroup":
                if let groupId = body["groupId"] as? String {
                    self.delegate?.showEditGroupDialog(groupId: groupId)
                }
            case "deleteGroup":
                if let groupId = body["groupId"] as? String {
                    self.delegate?.deleteGroup(groupId: groupId)
                }
            default:
                break
            }
        }
    }
}

// MARK: - Dialog WebView Handler

class DialogHandler: NSObject, WKScriptMessageHandler {
    weak var delegate: AppDelegate?
    
    func userContentController(_ userContentController: WKUserContentController, didReceive message: WKScriptMessage) {
        guard let body = message.body as? [String: Any],
              let action = body["action"] as? String else { return }
        
        DispatchQueue.main.async {
            switch action {
            case "browse":
                self.delegate?.browseFolder()
            case "save":
                self.delegate?.saveFromDialog(body)
            case "cancel":
                self.delegate?.cancelDialog()
            case "delete":
                self.delegate?.deleteFromDialog()
            default:
                break
            }
        }
    }
}

// MARK: - App Delegate

class AppDelegate: NSObject, NSApplicationDelegate {
    var statusItem: NSStatusItem!
    var mainWindow: NSWindow!
    var webView: WKWebView!
    var groups: [LinkGroup] = []
    var webHandler = WebHandler()
    var dialogHandler = DialogHandler()
    var currentGroupId: String?
    var currentLinkId: String?
    var dialogWindow: NSWindow?
    var dialogWebView: WKWebView?
    var isEditMode = false
    
    func applicationDidFinishLaunching(_ notification: Notification) {
        NSApp.setActivationPolicy(.accessory)
        webHandler.delegate = self
        dialogHandler.delegate = self
        loadData()
        setupStatusBar()
        createWindow()
        
        // Show window immediately on launch
        mainWindow.makeKeyAndOrderFront(nil)
        NSApp.activate(ignoringOtherApps: true)
    }
    
    func setupStatusBar() {
        statusItem = NSStatusBar.system.statusItem(withLength: NSStatusItem.squareLength)
        if let button = statusItem.button {
            button.title = "S"
            button.action = #selector(toggleWindow)
            button.target = self
        }
    }
    
    @objc func toggleWindow() {
        if mainWindow.isVisible {
            mainWindow.orderOut(nil)
        } else {
            mainWindow.makeKeyAndOrderFront(nil)
            NSApp.activate(ignoringOtherApps: true)
        }
    }
    
    func createWindow() {
        mainWindow = NSWindow(
            contentRect: NSRect(x: 0, y: 0, width: 900, height: 650),
            styleMask: [.titled, .closable, .resizable, .miniaturizable],
            backing: .buffered,
            defer: false
        )
        mainWindow.title = "Shortcuts Manager"
        mainWindow.center()
        mainWindow.isReleasedWhenClosed = false
        mainWindow.minSize = NSSize(width: 600, height: 400)
        
        let config = WKWebViewConfiguration()
        config.userContentController.add(webHandler, name: "swift")
        
        webView = WKWebView(frame: mainWindow.contentView!.bounds, configuration: config)
        webView.autoresizingMask = [.width, .height]
        mainWindow.contentView?.addSubview(webView)
        
        refreshWebView()
    }
    
    func refreshWebView() {
        let html = generateHTML()
        webView.loadHTMLString(html, baseURL: nil)
    }
    
    // MARK: - HTML Generation
    
    func generateHTML() -> String {
        let groupsJSON = (try? JSONEncoder().encode(groups)).flatMap { String(data: $0, encoding: .utf8) } ?? "[]"
        
        return """
        <!DOCTYPE html>
        <html>
        <head>
        <meta charset="UTF-8">
        <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #e8eaed 0%, #d4d7dc 100%);
            min-height: 100vh;
            padding: 20px;
            overflow: auto;
        }
        .canvas {
            position: relative;
            width: 100%;
            height: calc(100vh - 80px);
        }
        .group {
            position: absolute;
            width: 240px;
            background: #f8f9fa;
            border-radius: 14px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
            overflow: hidden;
        }
        .group-header {
            background: #2d3748;
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            font-size: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }
        .group-header:active { cursor: grabbing; }
        .add-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .add-btn:hover { background: rgba(255,255,255,0.3); }
        .header-btns { display: flex; gap: 4px; }
        .header-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            opacity: 0.7;
        }
        .header-btn:hover { opacity: 1; background: rgba(255,255,255,0.25); }
        .group-content {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 350px;
            overflow-y: auto;
        }
        .link-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .link-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .link-item:active { transform: scale(0.98); }
        .link-icon {
            margin-right: 10px;
            font-size: 16px;
        }
        .link-title { flex: 1; }
        .link-edit {
            opacity: 0;
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .link-item:hover .link-edit { opacity: 1; }
        .toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #e2e4e8;
            padding: 12px 20px;
            display: flex;
            gap: 10px;
        }
        .toolbar button {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            background: #4a5568;
            color: white;
        }
        .toolbar button:hover { background: #2d3748; }
        .toolbar .quit { margin-left: auto; background: #e53e3e; }
        .toolbar .quit:hover { background: #c53030; }
        </style>
        </head>
        <body>
        <div class="canvas" id="canvas"></div>
        <div class="toolbar">
            <button onclick="addGroup()">+ Add Group</button>
            <button class="quit" onclick="quit()">Quit</button>
        </div>
        
        <script>
        const groups = \(groupsJSON);
        let draggedGroup = null;
        let dragOffset = { x: 0, y: 0 };
        
        function render() {
            const canvas = document.getElementById('canvas');
            canvas.innerHTML = '';
            
            groups.forEach(group => {
                const el = document.createElement('div');
                el.className = 'group';
                el.style.left = group.x + 'px';
                el.style.top = group.y + 'px';
                el.dataset.id = group.id;
                
                el.innerHTML = `
                    <div class="group-header" onmousedown="startDrag(event, '${group.id}')">
                        <span>${group.title}</span>
                        <div class="header-btns">
                            <button class="header-btn" onclick="event.stopPropagation(); editGroup('${group.id}')" title="Edit group">‚úé</button>
                            <button class="header-btn" onclick="event.stopPropagation(); deleteGroup('${group.id}')" title="Delete group">‚úï</button>
                            <button class="add-btn" onclick="event.stopPropagation(); addLink('${group.id}')" title="Add link">+</button>
                        </div>
                    </div>
                    <div class="group-content">
                        ${group.links.map(link => `
                            <div class="link-item" style="background: ${link.color}" onclick="clickLink('${link.id}')">
                                <span class="link-icon">${link.icon}</span>
                                <span class="link-title">${link.title}</span>
                                <button class="link-edit" onclick="event.stopPropagation(); editLink('${group.id}', '${link.id}')">‚úé</button>
                            </div>
                        `).join('')}
                    </div>
                `;
                canvas.appendChild(el);
            });
        }
        
        function startDrag(e, groupId) {
            if (e.target.classList.contains('add-btn')) return;
            draggedGroup = groupId;
            const group = groups.find(g => g.id === groupId);
            dragOffset.x = e.clientX - group.x;
            dragOffset.y = e.clientY - group.y;
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', endDrag);
        }
        
        function onDrag(e) {
            if (!draggedGroup) return;
            const group = groups.find(g => g.id === draggedGroup);
            group.x = Math.max(0, e.clientX - dragOffset.x);
            group.y = Math.max(0, e.clientY - dragOffset.y);
            render();
        }
        
        function endDrag() {
            if (draggedGroup) {
                const group = groups.find(g => g.id === draggedGroup);
                window.webkit.messageHandlers.swift.postMessage({
                    action: 'moveGroup',
                    groupId: draggedGroup,
                    x: Math.round(group.x),
                    y: Math.round(group.y)
                });
            }
            draggedGroup = null;
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', endDrag);
        }
        
        function clickLink(linkId) {
            window.webkit.messageHandlers.swift.postMessage({ action: 'click', linkId: linkId });
        }
        
        function addLink(groupId) {
            window.webkit.messageHandlers.swift.postMessage({ action: 'addLink', groupId: groupId });
        }
        
        function editLink(groupId, linkId) {
            window.webkit.messageHandlers.swift.postMessage({ action: 'editLink', groupId: groupId, linkId: linkId });
        }
        
        function addGroup() {
            window.webkit.messageHandlers.swift.postMessage({ action: 'addGroup' });
        }
        
        function editGroup(groupId) {
            window.webkit.messageHandlers.swift.postMessage({ action: 'editGroup', groupId: groupId });
        }
        
        function deleteGroup(groupId) {
            window.webkit.messageHandlers.swift.postMessage({ action: 'deleteGroup', groupId: groupId });
        }
        
        function quit() {
            window.webkit.messageHandlers.swift.postMessage({ action: 'quit' });
        }
        
        render();
        </script>
        </body>
        </html>
        """
    }
    
    // MARK: - Actions from WebView
    
    func executeLink(linkId: String) {
        for group in groups {
            if let link = group.links.first(where: { $0.id == linkId }) {
                let payload = link.payload
                switch link.actionType {
                case "VS Code":
                    runProcess("/usr/bin/open", ["-a", "Visual Studio Code", payload])
                case "Finder":
                    runProcess("/usr/bin/open", [payload])
                case "Chrome":
                    runProcess("/usr/bin/open", ["-a", "Google Chrome", payload])
                case "Terminal":
                    // Create a temp script file and execute it in Terminal
                    let scriptPath = "/tmp/launcher_cmd.sh"
                    let scriptContent = "#!/bin/zsh\n\(payload)\nexec zsh"
                    try? scriptContent.write(toFile: scriptPath, atomically: true, encoding: .utf8)
                    try? FileManager.default.setAttributes([.posixPermissions: 0o755], ofItemAtPath: scriptPath)
                    runProcess("/usr/bin/open", ["-a", "Terminal", scriptPath])
                case "Shell":
                    runProcess("/bin/zsh", ["-l", "-c", payload])
                default:
                    break
                }
                return
            }
        }
    }
    
    func runProcess(_ path: String, _ args: [String]) {
        let p = Process()
        p.executableURL = URL(fileURLWithPath: path)
        p.arguments = args
        try? p.run()
    }
    
    func moveGroup(groupId: String, x: Int, y: Int) {
        if let idx = groups.firstIndex(where: { $0.id == groupId }) {
            groups[idx].x = x
            groups[idx].y = y
            saveData()
        }
    }
    
    // MARK: - Dialogs
    
    func showAddGroupDialog() {
        let alert = NSAlert()
        alert.messageText = "Add New Group"
        alert.addButton(withTitle: "Add")
        alert.addButton(withTitle: "Cancel")
        
        let input = NSTextField(frame: NSRect(x: 0, y: 0, width: 250, height: 24))
        input.placeholderString = "Group name"
        alert.accessoryView = input
        
        if alert.runModal() == .alertFirstButtonReturn {
            let title = input.stringValue.trimmingCharacters(in: CharacterSet.whitespaces)
            if !title.isEmpty {
                let newGroup = LinkGroup(title: title, x: 50 + groups.count * 30, y: 50 + groups.count * 30)
                groups.append(newGroup)
                saveData()
                refreshWebView()
            }
        }
    }
    
    func showEditGroupDialog(groupId: String) {
        guard let idx = groups.firstIndex(where: { $0.id == groupId }) else { return }
        
        let alert = NSAlert()
        alert.messageText = "Edit Group"
        alert.addButton(withTitle: "Save")
        alert.addButton(withTitle: "Cancel")
        
        let input = NSTextField(frame: NSRect(x: 0, y: 0, width: 250, height: 24))
        input.stringValue = groups[idx].title
        alert.accessoryView = input
        
        if alert.runModal() == .alertFirstButtonReturn {
            let title = input.stringValue.trimmingCharacters(in: CharacterSet.whitespaces)
            if !title.isEmpty {
                groups[idx].title = title
                saveData()
                refreshWebView()
            }
        }
    }
    
    func deleteGroup(groupId: String) {
        let alert = NSAlert()
        alert.messageText = "Delete this group?"
        alert.informativeText = "All links in this group will be deleted."
        alert.addButton(withTitle: "Delete")
        alert.addButton(withTitle: "Cancel")
        
        if alert.runModal() == .alertFirstButtonReturn {
            groups.removeAll { $0.id == groupId }
            saveData()
            refreshWebView()
        }
    }
    
    func showAddDialog(groupId: String) {
        currentGroupId = groupId
        currentLinkId = nil
        isEditMode = false
        showLinkDialog(link: nil)
    }
    
    func showEditDialog(groupId: String, linkId: String) {
        guard let gi = groups.firstIndex(where: { $0.id == groupId }),
              let li = groups[gi].links.firstIndex(where: { $0.id == linkId }) else { return }
        
        currentGroupId = groupId
        currentLinkId = linkId
        isEditMode = true
        showLinkDialog(link: groups[gi].links[li])
    }
    
    func showLinkDialog(link: QuickLink?) {
        dialogWindow = NSWindow(
            contentRect: NSRect(x: 0, y: 0, width: 500, height: 480),
            styleMask: [.titled],
            backing: .buffered,
            defer: false
        )
        dialogWindow?.title = link == nil ? "Add New Link" : "Edit Link"
        
        let config = WKWebViewConfiguration()
        config.userContentController.add(dialogHandler, name: "swift")
        
        dialogWebView = WKWebView(frame: dialogWindow!.contentView!.bounds, configuration: config)
        dialogWebView?.autoresizingMask = [.width, .height]
        dialogWindow?.contentView?.addSubview(dialogWebView!)
        
        let html = generateDialogHTML(link: link, showDelete: isEditMode)
        dialogWebView?.loadHTMLString(html, baseURL: nil)
        
        mainWindow.beginSheet(dialogWindow!) { _ in }
    }
    
    func generateDialogHTML(link: QuickLink?, showDelete: Bool) -> String {
        let linkJSON = link.flatMap { try? JSONEncoder().encode($0) }.flatMap { String(data: $0, encoding: .utf8) } ?? "null"
        
        return """
        <!DOCTYPE html>
        <html>
        <head>
        <meta charset="UTF-8">
        <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f7;
            padding: 20px;
        }
        h2 { margin-bottom: 20px; color: #333; }
        .form-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 6px; font-weight: 500; color: #555; }
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007aff;
        }
        .row { display: flex; gap: 12px; }
        .row .form-group { flex: 1; }
        .type-fields { display: none; }
        .type-fields.active { display: block; }
        .browse-row { display: flex; gap: 8px; }
        .browse-row input { flex: 1; }
        .browse-btn {
            padding: 10px 16px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }
        .browse-btn:hover { background: #0056b3; }
        .colors { display: flex; gap: 8px; margin-top: 8px; }
        .color-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 3px solid transparent;
            cursor: pointer;
        }
        .color-btn.selected { border-color: #333; }
        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid #ddd;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        .btn-save { background: #007aff; color: white; }
        .btn-save:hover { background: #0056b3; }
        .btn-cancel { background: #e5e5e5; color: #333; }
        .btn-cancel:hover { background: #d5d5d5; }
        .btn-delete { background: #ff3b30; color: white; }
        .btn-delete:hover { background: #d63028; }
        .right-btns { display: flex; gap: 8px; }
        .hint { font-size: 12px; color: #888; margin-top: 4px; }
        .ssh-row { display: flex; gap: 8px; }
        .ssh-row input:first-child { flex: 2; }
        .ssh-row input:last-child { flex: 1; }
        </style>
        </head>
        <body>
        <h2>\(link == nil ? "Add New Link" : "Edit Link")</h2>
        
        <div class="form-group">
            <label>Type</label>
            <select id="actionType" onchange="typeChanged()">
                <option value="VS Code">üìÇ VS Code - Open folder in VS Code</option>
                <option value="Finder">üìÅ Finder - Open folder/file</option>
                <option value="Chrome">üåê Chrome - Open URL</option>
                <option value="Terminal">üíª Terminal/SSH - Run command or SSH</option>
                <option value="Shell">‚ö° Shell Command - Run script</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Title</label>
            <input type="text" id="title" placeholder="My Project">
        </div>
        
        <!-- VS Code / Finder fields -->
        <div id="fields-folder" class="type-fields">
            <div class="form-group">
                <label>Folder Path</label>
                <div class="browse-row">
                    <input type="text" id="folderPath" placeholder="/Users/...">
                    <button class="browse-btn" onclick="browse()">Browse...</button>
                </div>
            </div>
        </div>
        
        <!-- Chrome fields -->
        <div id="fields-url" class="type-fields">
            <div class="form-group">
                <label>URL</label>
                <input type="text" id="urlPath" placeholder="https://example.com">
            </div>
        </div>
        
        <!-- Terminal/SSH fields -->
        <div id="fields-ssh" class="type-fields">
            <div class="form-group">
                <label>Connection Type</label>
                <select id="sshType" onchange="sshTypeChanged()">
                    <option value="ssh">SSH Connection</option>
                    <option value="command">Terminal Command</option>
                </select>
            </div>
            <div id="ssh-fields">
                <div class="form-group">
                    <label>Host</label>
                    <input type="text" id="sshHost" placeholder="192.168.1.10 or server.com">
                </div>
                <div class="row">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="sshUser" placeholder="root">
                    </div>
                    <div class="form-group">
                        <label>Port (optional)</label>
                        <input type="text" id="sshPort" placeholder="22">
                    </div>
                </div>
            </div>
            <div id="terminal-command-field" style="display:none">
                <div class="form-group">
                    <label>Command</label>
                    <input type="text" id="terminalCmd" placeholder="cd /path && ./script.sh">
                </div>
            </div>
        </div>
        
        <!-- Shell fields -->
        <div id="fields-shell" class="type-fields">
            <div class="form-group">
                <label>Shell Command</label>
                <textarea id="shellCmd" rows="3" placeholder="echo 'Hello'&#10;ls -la"></textarea>
                <div class="hint">Runs with /bin/zsh -l -c</div>
            </div>
        </div>
        
        <div class="row">
            <div class="form-group">
                <label>Icon (emoji)</label>
                <input type="text" id="icon" placeholder="üìÅ" style="width: 80px;">
            </div>
            <div class="form-group">
                <label>Color</label>
                <div class="colors">
                    <div class="color-btn selected" style="background:#3b82f6" data-color="#3b82f6" onclick="selectColor(this)"></div>
                    <div class="color-btn" style="background:#22c55e" data-color="#22c55e" onclick="selectColor(this)"></div>
                    <div class="color-btn" style="background:#f97316" data-color="#f97316" onclick="selectColor(this)"></div>
                    <div class="color-btn" style="background:#a855f7" data-color="#a855f7" onclick="selectColor(this)"></div>
                    <div class="color-btn" style="background:#ef4444" data-color="#ef4444" onclick="selectColor(this)"></div>
                    <div class="color-btn" style="background:#ec4899" data-color="#ec4899" onclick="selectColor(this)"></div>
                    <div class="color-btn" style="background:#14b8a6" data-color="#14b8a6" onclick="selectColor(this)"></div>
                    <div class="color-btn" style="background:#eab308" data-color="#eab308" onclick="selectColor(this)"></div>
                </div>
            </div>
        </div>
        
        <div class="buttons">
            <div>
                \(showDelete ? "<button class='btn btn-delete' onclick='deleteLink()'>Delete</button>" : "")
            </div>
            <div class="right-btns">
                <button class="btn btn-cancel" onclick="cancel()">Cancel</button>
                <button class="btn btn-save" onclick="save()">Save</button>
            </div>
        </div>
        
        <script>
        let selectedColor = '#3b82f6';
        const existingLink = \(linkJSON);
        
        function typeChanged() {
            const type = document.getElementById('actionType').value;
            document.querySelectorAll('.type-fields').forEach(el => el.classList.remove('active'));
            
            if (type === 'VS Code' || type === 'Finder') {
                document.getElementById('fields-folder').classList.add('active');
            } else if (type === 'Chrome') {
                document.getElementById('fields-url').classList.add('active');
            } else if (type === 'Terminal') {
                document.getElementById('fields-ssh').classList.add('active');
            } else if (type === 'Shell') {
                document.getElementById('fields-shell').classList.add('active');
            }
        }
        
        function sshTypeChanged() {
            const sshType = document.getElementById('sshType').value;
            document.getElementById('ssh-fields').style.display = sshType === 'ssh' ? 'block' : 'none';
            document.getElementById('terminal-command-field').style.display = sshType === 'command' ? 'block' : 'none';
        }
        
        function selectColor(el) {
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            selectedColor = el.dataset.color;
        }
        
        function browse() {
            window.webkit.messageHandlers.swift.postMessage({ action: 'browse' });
        }
        
        function setPath(path) {
            document.getElementById('folderPath').value = path;
        }
        
        function getPayload() {
            const type = document.getElementById('actionType').value;
            if (type === 'VS Code' || type === 'Finder') {
                return document.getElementById('folderPath').value;
            } else if (type === 'Chrome') {
                return document.getElementById('urlPath').value;
            } else if (type === 'Terminal') {
                const sshType = document.getElementById('sshType').value;
                if (sshType === 'ssh') {
                    const host = document.getElementById('sshHost').value;
                    const user = document.getElementById('sshUser').value;
                    const port = document.getElementById('sshPort').value;
                    let cmd = 'ssh ';
                    if (port && port !== '22') cmd += '-p ' + port + ' ';
                    if (user) cmd += user + '@';
                    cmd += host;
                    return cmd;
                } else {
                    return document.getElementById('terminalCmd').value;
                }
            } else if (type === 'Shell') {
                return document.getElementById('shellCmd').value;
            }
            return '';
        }
        
        function save() {
            const title = document.getElementById('title').value.trim();
            if (!title) { alert('Title is required'); return; }
            
            const payload = getPayload();
            if (!payload) { alert('Please fill in the required fields'); return; }
            
            window.webkit.messageHandlers.swift.postMessage({
                action: 'save',
                title: title,
                actionType: document.getElementById('actionType').value,
                payload: payload,
                icon: document.getElementById('icon').value || 'üîó',
                color: selectedColor
            });
        }
        
        function cancel() {
            window.webkit.messageHandlers.swift.postMessage({ action: 'cancel' });
        }
        
        function deleteLink() {
            if (confirm('Delete this link?')) {
                window.webkit.messageHandlers.swift.postMessage({ action: 'delete' });
            }
        }
        
        // Load existing data
        if (existingLink) {
            document.getElementById('title').value = existingLink.title;
            document.getElementById('actionType').value = existingLink.actionType;
            document.getElementById('icon').value = existingLink.icon;
            selectedColor = existingLink.color;
            document.querySelectorAll('.color-btn').forEach(b => {
                b.classList.toggle('selected', b.dataset.color === selectedColor);
            });
            
            typeChanged();
            
            const type = existingLink.actionType;
            const payload = existingLink.payload;
            
            if (type === 'VS Code' || type === 'Finder') {
                document.getElementById('folderPath').value = payload;
            } else if (type === 'Chrome') {
                document.getElementById('urlPath').value = payload;
            } else if (type === 'Terminal') {
                if (payload.startsWith('ssh ')) {
                    document.getElementById('sshType').value = 'ssh';
                    // Parse ssh command
                    const match = payload.match(/ssh\\s+(?:-p\\s+(\\d+)\\s+)?(?:([^@]+)@)?(.+)/);
                    if (match) {
                        if (match[1]) document.getElementById('sshPort').value = match[1];
                        if (match[2]) document.getElementById('sshUser').value = match[2];
                        if (match[3]) document.getElementById('sshHost').value = match[3];
                    }
                } else {
                    document.getElementById('sshType').value = 'command';
                    document.getElementById('terminalCmd').value = payload;
                }
                sshTypeChanged();
            } else if (type === 'Shell') {
                document.getElementById('shellCmd').value = payload;
            }
        } else {
            typeChanged();
        }
        </script>
        </body>
        </html>
        """
    }
    
    func browseFolder() {
        let panel = NSOpenPanel()
        panel.canChooseFiles = false
        panel.canChooseDirectories = true
        panel.allowsMultipleSelection = false
        
        if panel.runModal() == .OK, let url = panel.url {
            let path = url.path
            dialogWebView?.evaluateJavaScript("setPath('\(path.replacingOccurrences(of: "'", with: "\\'"))')", completionHandler: nil)
        }
    }
    
    func saveFromDialog(_ data: [String: Any]) {
        guard let title = data["title"] as? String,
              let actionType = data["actionType"] as? String,
              let payload = data["payload"] as? String,
              let icon = data["icon"] as? String,
              let color = data["color"] as? String,
              let groupId = currentGroupId else { return }
        
        if let linkId = currentLinkId {
            // Edit existing
            if let gi = groups.firstIndex(where: { $0.id == groupId }),
               let li = groups[gi].links.firstIndex(where: { $0.id == linkId }) {
                groups[gi].links[li].title = title
                groups[gi].links[li].actionType = actionType
                groups[gi].links[li].payload = payload
                groups[gi].links[li].icon = icon
                groups[gi].links[li].color = color
            }
        } else {
            // Add new
            let link = QuickLink(title: title, icon: icon, color: color, actionType: actionType, payload: payload)
            if let gi = groups.firstIndex(where: { $0.id == groupId }) {
                groups[gi].links.append(link)
            }
        }
        
        saveData()
        closeDialog()
        refreshWebView()
    }
    
    func cancelDialog() {
        closeDialog()
    }
    
    func deleteFromDialog() {
        if let groupId = currentGroupId, let linkId = currentLinkId {
            if let gi = groups.firstIndex(where: { $0.id == groupId }) {
                groups[gi].links.removeAll { $0.id == linkId }
                saveData()
            }
        }
        closeDialog()
        refreshWebView()
    }
    
    func closeDialog() {
        if let dw = dialogWindow {
            mainWindow.endSheet(dw)
            dialogWindow = nil
            dialogWebView = nil
        }
    }
    // MARK: - Persistence
    
    func loadData() {
        if let data = UserDefaults.standard.data(forKey: "shortcutGroups"),
           let decoded = try? JSONDecoder().decode([LinkGroup].self, from: data) {
            groups = decoded
        } else {
            groups = defaultGroups()
            saveData()
        }
    }
    
    func saveData() {
        if let data = try? JSONEncoder().encode(groups) {
            UserDefaults.standard.set(data, forKey: "shortcutGroups")
        }
    }
    
    func defaultGroups() -> [LinkGroup] {
        return [
            LinkGroup(title: "VSCode", x: 30, y: 30, links: [
                QuickLink(title: "Project01", icon: "üìä", color: "#3b82f6", actionType: "VS Code", payload: "/Users"),
                QuickLink(title: "[BCKeys]", icon: "‚ûï", color: "#22c55e", actionType: "VS Code", payload: "/Users"),
                QuickLink(title: "Config Files", icon: "üìÑ", color: "#f97316", actionType: "Finder", payload: "/Users"),
                QuickLink(title: "Dev Docs", icon: "üìù", color: "#a855f7", actionType: "Chrome", payload: "https://developer.apple.com")
            ]),
            LinkGroup(title: "Servers", x: 300, y: 30, links: [
                QuickLink(title: "192.168.1.10", icon: "‚â°", color: "#14b8a6", actionType: "Terminal", payload: "ssh user@192.168.1.10"),
                QuickLink(title: "DB Server", icon: "‚äï", color: "#ef4444", actionType: "Terminal", payload: "ssh db@server"),
                QuickLink(title: "AWS Console", icon: "‚òÅÔ∏è", color: "#eab308", actionType: "Chrome", payload: "https://aws.amazon.com/console"),
                QuickLink(title: "Prod Website", icon: "üåê", color: "#22c55e", actionType: "Chrome", payload: "https://example.com")
            ]),
            LinkGroup(title: "Seg√©dappok", x: 30, y: 280, links: [
                QuickLink(title: "K√©perny≈ëfot√≥", icon: "üì∑", color: "#ec4899", actionType: "Shell", payload: "screencapture -i ~/Desktop/screenshot.png"),
                QuickLink(title: "Sz√∂veg Converter", icon: "üì¶", color: "#14b8a6", actionType: "Finder", payload: "/Applications"),
                QuickLink(title: "SQL Tool", icon: "üíø", color: "#3b82f6", actionType: "Finder", payload: "/Applications"),
                QuickLink(title: "Automator Script", icon: "‚öôÔ∏è", color: "#a855f7", actionType: "Shell", payload: "automator ~/Scripts/myscript.workflow")
            ]),
            LinkGroup(title: "Munka", x: 300, y: 280, links: [
                QuickLink(title: "Kliens Projekt", icon: "üìß", color: "#3b82f6", actionType: "VS Code", payload: "/Users"),
                QuickLink(title: "Feladatok", icon: "üöÄ", color: "#ec4899", actionType: "Chrome", payload: "https://trello.com"),
                QuickLink(title: "Meeting Link", icon: "üì©", color: "#22c55e", actionType: "Chrome", payload: "https://meet.google.com"),
                QuickLink(title: "Jegyzetek", icon: "üìç", color: "#f97316", actionType: "Finder", payload: "~/Documents/Notes")
            ])
        ]
    }
}

// MARK: - NSColor Extension

extension NSColor {
    convenience init(hex: String) {
        var hexStr = hex.trimmingCharacters(in: CharacterSet.whitespaces)
        if hexStr.hasPrefix("#") {
            hexStr.removeFirst()
        }
        
        var rgb: UInt64 = 0
        Scanner(string: hexStr).scanHexInt64(&rgb)
        
        let r = CGFloat((rgb >> 16) & 0xFF) / 255.0
        let g = CGFloat((rgb >> 8) & 0xFF) / 255.0
        let b = CGFloat(rgb & 0xFF) / 255.0
        
        self.init(red: r, green: g, blue: b, alpha: 1.0)
    }
}

// MARK: - Entry Point

let app = NSApplication.shared
let delegate = AppDelegate()
app.delegate = delegate
app.run()
